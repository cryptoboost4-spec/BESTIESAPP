rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Helper to check if viewer can see check-in based on privacy level
    function canViewCheckIn(checkIn) {
      // Get privacy level (default to 'all_besties' for backward compatibility)
      let privacyLevel = checkIn.privacyLevel;
      let defaultPrivacy = !('privacyLevel' in checkIn);
      let inBestieIds = request.auth.uid in checkIn.bestieIds;
      let inCircle = 'circleSnapshot' in checkIn && request.auth.uid in checkIn.circleSnapshot;

      return (
        // Owner can always see their own check-ins
        isOwner(checkIn.userId) ||
        // Admins can see all check-ins
        isAdmin() ||
        // Privacy level: alerts_only - ONLY visible if alert triggered AND viewer was selected
        (privacyLevel == 'alerts_only' && checkIn.status == 'alerted' && inBestieIds) ||
        // Privacy level: circle - selected besties OR circle members can see
        (privacyLevel == 'circle' && (inBestieIds || inCircle)) ||
        // Privacy level: all_besties OR old check-ins without privacyLevel
        // Must be a bestie of the check-in owner (verified via bestieUserIds array)
        (privacyLevel == 'all_besties' || defaultPrivacy) &&
        request.auth.uid in get(/databases/$(database)/documents/users/$(checkIn.userId)).data.bestieUserIds
      );
    }
    
    // Users collection
    match /users/{userId} {
      // Users can always read their own profile
      // Besties can read each other's profiles (check both directions)
      // Admins can read all profiles
      allow read: if isSignedIn() && (
        request.auth.uid == userId ||
        // They have me in their bestieUserIds
        (resource.data.bestieUserIds != null && request.auth.uid in resource.data.bestieUserIds) ||
        // OR I have them in my bestieUserIds (allows reading right after adding them)
        (userId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.bestieUserIds) ||
        (resource.data.isAdmin == true && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true)
      );
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId &&
        (!request.resource.data.keys().hasAny(['role', 'banned', 'isAdmin']));
      allow delete: if isSignedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Check-ins collection
    match /checkins/{checkInId} {
      allow read: if isSignedIn() && canViewCheckIn(resource.data);

      allow create: if isSignedIn() &&
        request.auth.uid == request.resource.data.userId &&
        request.resource.data.keys().hasAll(['userId', 'location', 'duration', 'bestieIds', 'status', 'createdAt']) &&
        request.resource.data.status == 'active' &&
        request.resource.data.duration >= 10 &&
        request.resource.data.duration <= 180 &&
        request.resource.data.bestieIds.size() <= 5 &&
        (
          request.resource.data.bestieIds.size() > 0 ||
          ('messengerContactIds' in request.resource.data && request.resource.data.messengerContactIds.size() > 0)
        );

      allow update: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        (request.auth.uid in resource.data.bestieIds &&
         request.resource.data.status == 'false_alarm')
      );

      allow delete: if isOwner(resource.data.userId) || isAdmin();

      // Reactions subcollection for check-ins
      match /reactions/{reactionId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
      }

      // Comments subcollection for check-ins
      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
      }
    }
    
    // Besties collection
    match /besties/{bestieId} {
      allow read: if isAdmin() || (isSignedIn() && (
        request.auth.uid == resource.data.requesterId ||
        request.auth.uid == resource.data.recipientId ||
        // Allow reading pending invites sent to user's phone/email
        (resource.data.recipientPhone != null &&
         (request.auth.token.phone_number == resource.data.recipientPhone ||
          request.auth.token.email == resource.data.recipientPhone))
      ));

      allow create: if isSignedIn() && (
        // Normal request: user creates pending bestie request
        (request.auth.uid == request.resource.data.requesterId &&
         request.resource.data.keys().hasAll(['requesterId', 'recipientPhone', 'status', 'createdAt']) &&
         request.resource.data.status == 'pending') ||
        // Invite link: user accepts invite by creating accepted connection
        (request.auth.uid == request.resource.data.recipientId &&
         request.resource.data.keys().hasAll(['requesterId', 'recipientId', 'status', 'createdAt', 'acceptedAt']) &&
         request.resource.data.status == 'accepted')
      );
      
      allow update: if isSignedIn() && (
        // Recipient can accept/decline
        (request.auth.uid == resource.data.recipientId &&
         request.resource.data.status in ['accepted', 'declined']) ||
        // User accepting invite link (setting themselves as recipientId)
        (request.auth.uid == request.resource.data.recipientId &&
         request.resource.data.status == 'accepted') ||
        // User converting pending invite to accepted (via invite link)
        (request.auth.uid == request.resource.data.recipientId &&
         !('recipientId' in resource.data) &&
         request.resource.data.status == 'accepted') ||
        // Requester can cancel
        (request.auth.uid == resource.data.requesterId &&
         request.resource.data.status == 'cancelled')
      );
      
      allow delete: if isSignedIn() && (
        request.auth.uid == resource.data.requesterId ||
        request.auth.uid == resource.data.recipientId ||
        isAdmin()
      );
    }
    
    // Templates collection
    match /templates/{templateId} {
      allow read: if isAdmin() || isOwner(resource.data.userId);
      allow create: if isSignedIn() &&
        request.auth.uid == request.resource.data.userId;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isAdmin() || isOwner(resource.data.userId);
    }
    
    // Badges collection - public (anyone can see badges)
    // Profile visibility controls WHO can access profiles, not individual fields
    match /badges/{userId} {
      allow read: if isSignedIn(); // Any logged-in user can read badges
      allow create, update: if false; // Only Cloud Functions
      allow delete: if isAdmin();
    }
    
    // Analytics collections (admin-only read)
    // Allow unauthenticated writes for analytics to track signup funnel
    match /errors/{errorId} {
      allow create: if true; // Allow anonymous tracking
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    match /performance/{perfId} {
      allow create: if true; // Allow anonymous tracking
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    match /user_actions/{actionId} {
      allow create: if true; // Allow anonymous tracking
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    match /funnel_events/{eventId} {
      allow create: if true; // Allow anonymous tracking
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    
    // Alerts collection
    match /alerts/{alertId} {
      allow read: if isAdmin() || (isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid in resource.data.notifiedBesties
      ));
      allow create: if false; // Only Cloud Functions
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid in resource.data.notifiedBesties
      );
      allow delete: if isAdmin();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAdmin() || isOwner(resource.data.userId);
      allow create: if false; // Only Cloud Functions
      allow update: if isOwner(resource.data.userId);
      allow delete: if isAdmin();
    }

    // Emergency SOS collection
    match /emergency_sos/{sosId} {
      allow read: if isAdmin() || (isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid in resource.data.notifiedBesties
      ));
      allow create: if isSignedIn() &&
        request.auth.uid == request.resource.data.userId;
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid in resource.data.notifiedBesties
      );
      allow delete: if isAdmin();
    }

    // Bestie Celebrations collection
    match /bestie_celebrations/{celebrationId} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow create: if isSignedIn(); // Created by system when bestie connection is made
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow delete: if isAdmin() || (isSignedIn() && request.auth.uid == resource.data.userId);
    }

    // Posts collection
    match /posts/{postId} {
      // Posts are visible to all authenticated users
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow delete: if isAdmin() || (isSignedIn() && request.auth.uid == resource.data.userId);

      // Reactions subcollection
      match /reactions/{reactionId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
      }

      // Comments subcollection
      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
      }
    }

    // Alert Responses collection - tracks when besties respond to alerts
    match /alert_responses/{responseId} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid == resource.data.responderId
      );
      allow create: if false; // Only Cloud Functions
      allow update, delete: if isAdmin();
    }

    // Interactions collection - tracks all bestie interactions
    match /interactions/{interactionId} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid == resource.data.bestieId
      );
      allow create: if false; // Only Cloud Functions
      allow update, delete: if isAdmin();
    }

    // Circle Milestones collection - celebration milestones
    match /circle_milestones/{milestoneId} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow create: if false; // Only Cloud Functions
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId; // Allow marking as celebrated
      allow delete: if isAdmin();
    }
    // Facebook Messenger Contacts collection
    match /messengerContacts/{contactId} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow write: if false; // Only backend can write
    }


    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
